{% extends "base.html" %}
{% block content %}
<div class="content">
  <h2 style="text-align:center; color:#4f8cff; margin-bottom:2rem;">User Settings & Management</h2>
  <div class="user-management">
    <!-- Add User -->
    <div class="card">
      <h3>Add User</h3>
      <form method="POST" action="{{ url_for('add_user') }}">
        <label for="add-username">Username</label>
        <input type="text" id="add-username" name="username" placeholder="Enter username" required>
        <label for="add-password">Password</label>
        <input type="password" id="add-password" name="password" placeholder="Enter password" required>
        <label for="add-email">Email</label>
        <input type="email" id="add-email" name="email" placeholder="Enter email" required>
        <button type="submit">Add User</button>
      </form>
    </div>

    <!-- Reset Any User's Password -->
    <div class="card">
      <h3>Reset User Password</h3>
      <form method="POST" action="{{ url_for('reset_password') }}">
        <label for="reset-username">Username</label>
        <input type="text" id="reset-username" name="username" placeholder="Enter username" required>
        <label for="reset-password">New Password</label>
        <input type="password" id="reset-password" name="password" placeholder="Enter new password" required>
        <button type="submit">Reset Password</button>
      </form>
    </div>

    <!-- Change Own Password -->
    <div class="card">
      <h3>Change My Password</h3>
      <form method="POST" action="{{ url_for('reset_password') }}">
        <label for="current-password">Current Password</label>
        <input type="password" id="current-password" name="current_password" placeholder="Current password" required>
        <label for="new-password">New Password</label>
        <input type="password" id="new-password" name="new_password" placeholder="New password" required>
        <button type="submit">Change Password</button>
      </form>
    </div>

    <!-- Update Profile -->
    <div class="card">
      <h3>Update My Profile</h3>
      <form method="POST" action="{{ url_for('update_profile') }}">
        <label for="profile-username">Username</label>
        <input type="text" id="profile-username" name="username" value="{{ current_user.username }}" readonly>
        <label for="profile-email">Email</label>
        <input type="email" id="profile-email" name="email" value="{{ current_user.email }}" required>
        <button type="submit">Update Profile</button>
      </form>
    </div>

    <!-- to reset the databae -->
    <div class="card" style="border:2px solid #ff3b30;">
      <h3 style="color:#ff3b30;">Danger Zone</h3>
      <form method="POST" action="{{ url_for('reinit_db') }}" onsubmit="return confirm('Are you sure you want to reinitialize the database? This will DELETE ALL DATA and cannot be undone!');">
        <button type="submit" style="background:#ff3b30;">Reinitialize Database</button>
        <p style="color:#b71c1c;font-size:0.95em;margin-top:1em;">This will remove <b>all users, instances, and backups</b> and create a new empty database.</p>
      </form>
    </div>

    <!-- Two-Factor Authentication (UI only) -->
    <div class="card">
      <h3>Two-Factor Authentication</h3>
      {% if current_user.two_factor_enabled %}
        <form method="POST" action="{{ url_for('toggle_2fa') }}">
          <label style="display:flex;align-items:center;gap:0.5em;">
            <input type="checkbox" name="enable_2fa" checked>
            Disable Two-Factor Authentication
          </label>
          <button type="submit">Update 2FA Settings</button>
        </form>
        <p style="font-size:0.9em;color:#888;margin-top:1em;">
          2FA is currently <b>enabled</b> on your account.
        </p>
      {% else %}
        <a href="{{ url_for('setup_2fa') }}" class="button" style="margin-top:1em;">
          Enable Two-Factor Authentication
        </a>
        <p style="font-size:0.9em;color:#888;margin-top:1em;">
          For extra account security, enable two-factor authentication (2FA).
        </p>
      {% endif %}
    </div>


  <!-- User List -->
  <div class="section" style="margin-top:2.5rem;">
    <div class="card user-list-card">
      <h3>All Users</h3>
      <ul class="user-list">
        {% for user in users %}
        <li>
          <span>
            <strong>{{ user.username }}</strong> ({{ user.email }})
            {% if user.is_admin %}
              <span style="color:#4f8cff;font-weight:bold;">[Admin]</span>
            {% endif %}
            {% if user.two_factor_enabled %}
              <span style="color:green;">2FA Enabled</span>
            {% endif %}            
          </span>
          <form method="POST" action="{{ url_for('delete_user', username=user.username) }}" style="display:inline;">
            <button type="submit" class="danger" onclick="return confirm('Delete this user?');" {% if user.username == current_user.username %}disabled title="You cannot delete your own account"{% endif %}>Delete</button>
          </form>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}
